<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trip Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ff0000, #ff9900, #33cc33, #3399ff, #cc33cc);
            color: #1f2937;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section-container {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
            background: linear-gradient(45deg, #ff6666, #ffcc66);
            color: white;
        }
        .tab-button.active {
            background: linear-gradient(45deg, #cc33cc, #3399ff);
            color: white;
            border-top: 2px solid #cc33cc;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            border-bottom: none;
        }
        .tab-button:hover {
            background: linear-gradient(45deg, #ff3333, #ff9933);
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .input-group input, .input-group textarea, .input-group select {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #cc33cc;
        }
        .item-list {
            list-style: none;
            padding: 0;
        }
        .item-list li {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn, .edit-btn {
            background: linear-gradient(45deg, #ff6666, #ffcc66);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            margin-left: 0.5rem;
        }
        .delete-btn:hover, .edit-btn:hover {
            background: linear-gradient(45deg, #ff3333, #ff9933);
        }
        .pay-btn, .pdf-btn {
            background: linear-gradient(45deg, #33cc33, #3399ff);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            margin-left: 0.5rem;
        }
        .pay-btn:hover, .pdf-btn:hover {
            background: linear-gradient(45deg, #00cc00, #0066ff);
        }
        .pay-btn.disabled {
            background: linear-gradient(45deg, #9ca3af, #9ca3af);
            cursor: not-allowed;
        }
        .modal-flex {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .report-summary {
            background-color: #f0fdf4;
            border: 2px solid #4ade80;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .report-summary h3 {
            font-weight: bold;
            font-size: 1.25rem;
            color: #166534;
            margin-bottom: 1rem;
        }
        .backup-section {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .select-all {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .no-users-message {
            padding: 1rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        .user-trip-list {
            margin-top: 1rem;
        }
        .trip-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .trip-item:last-child {
            border-bottom: none;
        }
        .trip-checkbox {
            margin-right: 1rem;
        }
        .trip-details p {
            margin: 0;
        }
        .total-summary {
            margin-top: 1rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-8 text-white">Trip Tracker</h1>
        <p class="text-center text-sm text-white mb-4">Data synced via Firebase for phone and computer use.</p>

        <!-- Tabs -->
        <div class="flex">
            <button id="tripsTab" class="tab-button active">Trips</button>
            <button id="usersTab" class="tab-button">Users</button>
            <button id="payTab" class="tab-button">Pay Trip Fees</button>
            <button id="advancedTab" class="tab-button">Advanced</button>
        </div>

        <!-- Trips Section -->
        <div id="tripsSection" class="section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Log a New Trip</h2>
            <form id="tripForm" class="space-y-4">
                <div class="input-group">
                    <label>Responsible Users</label>
                    <div id="tripUsersContainer" class="flex flex-wrap gap-2">
                        <!-- Checkboxes will be dynamically added here -->
                    </div>
                </div>
                <div id="favoritesSection" class="input-group hidden">
                    <label for="favoriteTrip">Favorites</label>
                    <select id="favoriteTrip">
                        <option value="">Select a favorite trip</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="tripDestination">Destination</label>
                    <input type="text" id="tripDestination" placeholder="e.g., San Francisco, CA" required>
                </div>
                <div class="input-group">
                    <label for="tripMiles">Miles Driven</label>
                    <input type="number" min="0" id="tripMiles" placeholder="e.g., 250" required>
                </div>
                <div class="input-group">
                    <label for="tripGasPrice">Gas Price Per Gallon ($) (Optional)</label>
                    <input type="number" min="0" step="0.01" id="tripGasPrice" placeholder="e.g., 3.50, leave blank for default">
                </div>
                <div class="input-group">
                    <label for="tripDateTime">Date and Time</label>
                    <input type="datetime-local" id="tripDateTime" required>
                </div>
                <div class="input-group">
                    <label for="tripNotes">Notes</label>
                    <textarea id="tripNotes" placeholder="e.g., Drove to the conference" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label class="flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300">
                        <input type="checkbox" id="tripFavorite" class="form-checkbox text-blue-600 rounded">
                        <span>Mark as Favorite</span>
                    </label>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors">Add Trip</button>
            </form>

            <h2 class="text-2xl font-bold mt-8 mb-4">Logged Trips (Unpaid Only)</h2>
            <ul id="tripsList" class="item-list"></ul>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
            <form id="userForm" class="space-y-4 mb-8">
                <div class="input-group">
                    <label for="userName">User Name</label>
                    <input type="text" id="userName" placeholder="e.g., John Doe" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors">Add User</button>
            </form>
            <h2 class="text-2xl font-bold mb-4">Current Users</h2>
            <ul id="usersList" class="item-list"></ul>
        </div>

        <!-- Pay Trip Fees Section -->
        <div id="paySection" class="hidden section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Pay Trip Fees</h2>
            <form id="payForm" class="space-y-4">
                <div class="input-group">
                    <label>Users with Unpaid Trips</label>
                    <div id="payUsersContainer" class="flex flex-wrap gap-2">
                        <!-- Checkboxes will be dynamically added here -->
                    </div>
                </div>
                <div id="payTripsContainer" class="user-trip-list"></div>
                <div id="payTotals" class="total-summary"></div>
                <div class="input-group">
                    <label for="gasPrice">Default Gas Price Per Gallon ($)</label>
                    <input type="number" min="0" step="0.01" id="gasPrice" placeholder="e.g., 3.50" required>
                </div>
                <div class="input-group">
                    <label for="avgMpg">Average MPG</label>
                    <input type="number" min="0.1" step="0.1" id="avgMpg" placeholder="e.g., 25.5" required>
                </div>
                <button id="payNowBtn" type="button" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors disabled" disabled>Pay Now (Checked Trips Only)</button>
            </form>
            <div id="reportContainer" class="hidden"></div>
        </div>

        <!-- Advanced Section -->
        <div id="advancedSection" class="hidden section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Advanced Search (All Trips, Paid or Unpaid)</h2>
            <form id="searchForm" class="space-y-4">
                <div class="input-group">
                    <label>Users (Optional - Check to Filter)</label>
                    <div id="searchUsersContainer" class="flex flex-wrap gap-2">
                        <div class="select-all flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300">
                            <input type="checkbox" id="selectAllSearchUsers" class="form-checkbox text-blue-600 rounded">
                            <span>Select All</span>
                        </div>
                        <!-- Checkboxes will be dynamically added here -->
                    </div>
                </div>
                <div class="input-group">
                    <label>Display Options</label>
                    <div class="flex gap-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="showUnpaid" class="form-checkbox text-blue-600 rounded" checked>
                            <span>Unpaid</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="showPaid" class="form-checkbox text-blue-600 rounded" checked>
                            <span>Paid</span>
                        </label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="startDate">Start Date (Optional)</label>
                    <input type="date" id="startDate">
                </div>
                <div class="input-group">
                    <label for="endDate">End Date (Optional)</label>
                    <input type="date" id="endDate">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors">Search Trips</button>
                <button id="resetDatesBtn" type="button" class="w-full bg-gradient-to-r from-red-400 to-red-500 text-white font-bold py-3 rounded-lg hover:from-red-500 hover:to-red-600 transition-colors mt-2">Reset Dates</button>
            </form>
            <div id="searchResults" class="mt-4"></div>
        </div>

        <!-- Custom Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-flex p-4">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full shadow-lg text-center">
                <p id="modalMessage" class="mb-4 text-lg"></p>
                <div id="modalButtons" class="flex justify-center gap-4">
                    <button id="modalConfirm" class="bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors hidden">Confirm</button>
                    <button id="modalClose" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (your specific Trip Tracker project)
        const appId = 'trip-tracker-de1de';
        const firebaseConfig = {
          apiKey: "AIzaSyD4jiHf1fvWDW8vSHLyBRYCdNDXrizx0ms",
          authDomain: "trip-tracker-de1de.firebaseapp.com",
          projectId: "trip-tracker-de1de",
          storageBucket: "trip-tracker-de1de.firebasestorage.app",
          messagingSenderId: "302935799792",
          appId: "1:302935799792:web:8b7893586487403a688f35"
        };

        // Initialize Firebase
        let db = null, auth = null, userId = null;
        let users = [];
        let trips = [];

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated with ID:", userId);
                        setupRealtimeListeners();
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showModal("Could not connect to Firebase. Please check the console.", false);
            }
        }

        // ---------- UI Helpers ----------
        function switchTab(tabName) {
            const tabs = {
                trips: { button: 'tripsTab', section: 'tripsSection' },
                users: { button: 'usersTab', section: 'usersSection' },
                pay: { button: 'payTab', section: 'paySection' },
                advanced: { button: 'advancedTab', section: 'advancedSection' }
            };

            Object.keys(tabs).forEach(key => {
                const btn = document.getElementById(tabs[key].button);
                const sec = document.getElementById(tabs[key].section);
                if (key === tabName) {
                    btn.classList.add('active');
                    sec.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    sec.classList.add('hidden');
                }
            });
        }

        function showModal(message, isConfirmation = false, onConfirmCallback = null) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirm');
            const modalCloseBtn = document.getElementById('modalClose');

            modalMessage.innerHTML = message; // Allow HTML for edit form

            if (isConfirmation) {
                modalConfirmBtn.classList.remove('hidden');
                modalCloseBtn.textContent = 'Cancel';
                modalConfirmBtn.onclick = () => {
                    hideModal();
                    if (onConfirmCallback) onConfirmCallback();
                };
            } else {
                modalConfirmBtn.classList.add('hidden');
                modalCloseBtn.textContent = 'OK';
                modalCloseBtn.onclick = hideModal;
            }
            modal.classList.remove('hidden');
        }

        function hideModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
        }

        // ---------- Firestore Realtime Listeners ----------
        function setupRealtimeListeners() {
            if (!db) return;

            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            onSnapshot(usersCollectionRef, (userSnapshot) => {
                users = userSnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                console.log("Users updated:", users.length);
                renderAll();
            }, (error) => console.error("Error getting users:", error));

            const tripsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips`);
            onSnapshot(tripsCollectionRef, (tripSnapshot) => {
                trips = tripSnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                trips.sort((a, b) => {
                    const aTime = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                    const bTime = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                    return bTime - aTime;
                });
                console.log("Trips updated:", trips.length);
                renderAll();
            }, (error) => console.error("Error getting trips:", error));
        }

        function renderAll() {
            displayUsers();
            renderTripUserCheckboxes();
            renderPayUserCheckboxes();
            renderSearchUserCheckboxes();
            displayTrips();
        }

        // ---------- Data Helpers ----------
        async function deleteUser(userIdToDelete) {
            if (!db) return;
            const tripsWithUser = trips.filter(trip => trip.users.includes(userIdToDelete));
            if (tripsWithUser.length > 0) {
                showModal(`Cannot delete user. Associated with ${tripsWithUser.length} trip(s).`, false);
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userIdToDelete));
                showModal('User deleted successfully!');
            } catch (error) {
                console.error("Error deleting user:", error);
                showModal(`Failed to delete user: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
            }
        }

        async function deleteTrip(tripId) {
            if (!db) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId));
                showModal('Trip deleted successfully!');
            } catch (error) {
                console.error("Error deleting trip:", error);
                showModal(`Failed to delete trip: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
            }
        }

        async function updateTrip(tripId, updatedData) {
            if (!db) return;
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/trips`, tripId), {
                    ...updatedData,
                    timestamp: updatedData.timestamp || serverTimestamp()
                });
                showModal('Trip updated successfully!');
            } catch (error) {
                console.error("Error updating trip:", error);
                showModal(`Failed to update trip: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
            }
        }

        // ---------- UI Render Functions ----------
        function renderTripUserCheckboxes() {
            const usersContainer = document.getElementById('tripUsersContainer');
            if (!usersContainer) return;
            usersContainer.innerHTML = '';
            if (users.length === 0) {
                usersContainer.innerHTML = '<p class="no-users-message">No users yet—add some in the Users tab.</p>';
                return;
            }
            users.forEach(user => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'tripUser';
                input.value = user.id;
                input.className = 'form-checkbox text-blue-600 rounded';
                const span = document.createElement('span');
                span.textContent = escapeHtml(user.name);
                label.appendChild(input);
                label.appendChild(span);
                usersContainer.appendChild(label);
            });
            document.querySelectorAll('input[name="tripUser"]').forEach(cb => {
                cb.addEventListener('change', updateFavoritesSection);
            });
            updateFavoritesSection();
        }

        function updateFavoritesSection() {
            const checked = document.querySelectorAll('input[name="tripUser"]:checked');
            const favoritesSection = document.getElementById('favoritesSection');
            const favoriteSelect = document.getElementById('favoriteTrip');
            if (checked.length !== 1) {
                favoritesSection.classList.add('hidden');
                favoriteSelect.value = '';
                document.getElementById('tripFavorite').checked = false;
                return;
            }
            const userId = checked[0].value;
            const user = users.find(u => u.id === userId);
            const favs = user.favorites || [];
            favoriteSelect.innerHTML = '<option value="">Select a favorite trip</option>';
            favs.forEach(tripId => {
                const trip = trips.find(t => t.id === tripId);
                if (trip) {
                    const opt = document.createElement('option');
                    opt.value = trip.id;
                    opt.textContent = escapeHtml(trip.destination);
                    favoriteSelect.appendChild(opt);
                }
            });
            favoritesSection.classList.remove('hidden');
        }

        function renderPayUserCheckboxes() {
            const usersContainer = document.getElementById('payUsersContainer');
            if (!usersContainer) return;
            usersContainer.innerHTML = '';
            const usersWithUnpaid = users.filter(user => trips.some(trip => trip.users.includes(user.id) && !trip.paid));
            if (usersWithUnpaid.length === 0) {
                usersContainer.innerHTML = '<p class="no-users-message">No users with unpaid trips.</p>';
                return;
            }
            usersWithUnpaid.forEach(user => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'payUser';
                input.value = user.id;
                input.className = 'form-checkbox text-blue-600 rounded';
                const span = document.createElement('span');
                span.textContent = escapeHtml(user.name);
                label.appendChild(input);
                label.appendChild(span);
                usersContainer.appendChild(label);
            });
        }

        function renderSearchUserCheckboxes() {
            const usersContainer = document.getElementById('searchUsersContainer');
            if (!usersContainer) return;
            // Select All is already in HTML inside container
            usersContainer.querySelectorAll('label:not(.select-all)').forEach(el => el.remove()); // Clear dynamic ones
            if (users.length === 0) {
                usersContainer.innerHTML += '<p class="no-users-message">No users yet.</p>';
                return;
            }
            users.forEach(user => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'searchUser';
                input.value = user.id;
                input.className = 'form-checkbox text-blue-600 rounded';
                const span = document.createElement('span');
                span.textContent = escapeHtml(user.name);
                label.appendChild(input);
                label.appendChild(span);
                usersContainer.appendChild(label);
            });
            const selectAll = document.getElementById('selectAllSearchUsers');
            selectAll.addEventListener('change', () => {
                document.querySelectorAll('input[name="searchUser"]').forEach(cb => cb.checked = selectAll.checked);
                updateSearchResults();
            });
            document.querySelectorAll('input[name="searchUser"]').forEach(cb => {
                cb.addEventListener('change', updateSearchResults);
            });
            document.getElementById('showUnpaid').addEventListener('change', updateSearchResults);
            document.getElementById('showPaid').addEventListener('change', updateSearchResults);
        }

        function updateSearchResults() {
            const selectedUserCheckboxes = document.querySelectorAll('input[name="searchUser"]:checked');
            const selectedUserIds = Array.from(selectedUserCheckboxes).map(cb => cb.value);
            const showUnpaid = document.getElementById('showUnpaid').checked;
            const showPaid = document.getElementById('showPaid').checked;
            const startDateStr = document.getElementById('startDate')?.value;
            const endDateStr = document.getElementById('endDate')?.value;

            let filteredTrips = [];
            if (selectedUserIds.length > 0) {
                filteredTrips = trips.filter(trip => {
                    if (!selectedUserIds.some(id => trip.users.includes(id))) return false;
                    if ((trip.paid && !showPaid) || (!trip.paid && !showUnpaid)) return false;
                    if (startDateStr && endDateStr) {
                        const start = new Date(startDateStr + 'T00:00:00');
                        const end = new Date(endDateStr + 'T23:59:59.999');
                        const tripDate = new Date(trip.timestamp);
                        return tripDate >= start && tripDate <= end;
                    }
                    return true;
                });
            }

            generateSearchReport(filteredTrips);
        }

        function displayUsers() {
            const usersListElement = document.getElementById('usersList');
            if (!usersListElement) return;
            usersListElement.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = escapeHtml(user.name);
                li.appendChild(nameSpan);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    showModal(`Are you sure you want to delete "${escapeHtml(user.name)}"?`, true, () => deleteUser(user.id));
                });
                li.appendChild(deleteBtn);
                usersListElement.appendChild(li);
            });
        }

        function displayTrips() {
            const tripsListElement = document.getElementById('tripsList');
            if (!tripsListElement) return;
            // Only show unpaid trips
            const unpaidTrips = trips.filter(trip => !trip.paid);
            tripsListElement.innerHTML = '';

            unpaidTrips.forEach(trip => {
                const responsibleUserNames = Array.isArray(trip.users) ? trip.users.map(userId => {
                    const u = users.find(x => x.id === userId);
                    return u ? escapeHtml(u.name) : 'Unknown User';
                }).join(', ') : 'N/A';
                const dateStr = trip.timestamp ? new Date(trip.timestamp).toLocaleString() : 'Unknown';
                const sharedNote = trip.shared ? `(Shared with: ${trip.sharedWith ? trip.sharedWith.map(id => users.find(u => u.id === id)?.name || 'Unknown').join(', ') : ''})` : '';
                const gasPriceDisplay = trip.gasPrice ?? 'N/A';

                const li = document.createElement('li');
                li.className = 'flex justify-between items-start';
                const left = document.createElement('div');
                left.innerHTML = `
                    <p class="font-bold">${escapeHtml(trip.destination || 'No destination')} ${escapeHtml(sharedNote)}</p>
                    <p class="text-sm text-gray-500">Miles: ${escapeHtml(String(trip.miles ?? '0'))}</p>
                    <p class="text-sm text-gray-500">Gas Price: $${escapeHtml(String(gasPriceDisplay))}</p>
                    <p class="text-sm text-gray-500">Users: ${escapeHtml(responsibleUserNames)}</p>
                    <p class="text-sm text-gray-500">Notes: ${escapeHtml(trip.notes || 'N/A')}</p>
                    <p class="text-sm text-gray-500">Date: ${escapeHtml(dateStr)}</p>
                    <p class="text-sm text-gray-500">Status: ${trip.paid ? 'Paid' : 'Unpaid'}</p>
                `;
                const buttons = document.createElement('div');
                if (!trip.paid) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'Edit';
                    editBtn.addEventListener('click', () => openEditTripForm(trip));
                    buttons.appendChild(editBtn);
                }
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    showModal(`Are you sure you want to delete the trip to "${escapeHtml(trip.destination)}"?`, true, () => deleteTrip(trip.id));
                });
                buttons.appendChild(deleteBtn);
                li.appendChild(left);
                li.appendChild(buttons);
                tripsListElement.appendChild(li);
            });
            if (unpaidTrips.length === 0) {
                tripsListElement.innerHTML = '<li class="text-gray-500">No unpaid trips.</li>';
            }
        }

        function openEditTripForm(trip) {
            const formHtml = `
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Edit Trip to ${escapeHtml(trip.destination)}</h3>
                    <form id="editTripForm" class="space-y-4">
                        <div class="input-group">
                            <label>Responsible Users</label>
                            <div id="editTripUsersContainer" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="input-group">
                            <label for="editTripDestination">Destination</label>
                            <input type="text" id="editTripDestination" value="${escapeHtml(trip.destination)}" required>
                        </div>
                        <div class="input-group">
                            <label for="editTripMiles">Miles Driven</label>
                            <input type="number" min="0" id="editTripMiles" value="${trip.miles}" required>
                        </div>
                        <div class="input-group">
                            <label for="editTripGasPrice">Gas Price Per Gallon ($) (Optional)</label>
                            <input type="number" min="0" step="0.01" id="editTripGasPrice" value="${trip.gasPrice || ''}">
                        </div>
                        <div class="input-group">
                            <label for="editTripDateTime">Date and Time</label>
                            <input type="datetime-local" id="editTripDateTime" value="${trip.timestamp ? new Date(trip.timestamp).toISOString().slice(0, 16) : ''}" required>
                        </div>
                        <div class="input-group">
                            <label for="editTripNotes">Notes</label>
                            <textarea id="editTripNotes" rows="3">${escapeHtml(trip.notes || '')}</textarea>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 rounded-lg hover:from-green-500 hover:to-blue-600 transition-colors">Save Changes</button>
                    </form>
                </div>
            `;
            showModal(formHtml, false);
            const editUsersContainer = document.getElementById('editTripUsersContainer');
            users.forEach(user => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'editTripUser';
                input.value = user.id;
                input.className = 'form-checkbox text-blue-600 rounded';
                if (trip.users.includes(user.id)) input.checked = true;
                const span = document.createElement('span');
                span.textContent = escapeHtml(user.name);
                label.appendChild(input);
                label.appendChild(span);
                editUsersContainer.appendChild(label);
            });
            document.getElementById('editTripForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const destination = document.getElementById('editTripDestination').value.trim();
                const miles = parseFloat(document.getElementById('editTripMiles').value);
                if (miles <= 0) {
                    showModal('Miles must be positive.');
                    return;
                }
                const gasPrice = parseFloat(document.getElementById('editTripGasPrice').value) || null;
                const timestampStr = document.getElementById('editTripDateTime').value;
                if (!timestampStr) {
                    showModal('Please select a date and time.');
                    return;
                }
                const timestamp = new Date(timestampStr).toISOString();
                const notes = document.getElementById('editTripNotes').value.trim();
                const selectedUserIds = Array.from(document.querySelectorAll('input[name="editTripUser"]:checked')).map(cb => cb.value);

                if (selectedUserIds.length === 0) {
                    showModal("Please select at least one responsible user.");
                    return;
                }

                const updatedData = {
                    destination,
                    miles,
                    gasPrice,
                    timestamp,
                    notes,
                    users: selectedUserIds,
                    shared: selectedUserIds.length > 1,
                    sharedWith: selectedUserIds.length > 1 ? selectedUserIds : []
                };
                await updateTrip(trip.id, updatedData);
            });
        }

        function generateReport(selectedTrips, gasPrice, avgMpg) {
            const totalMiles = selectedTrips.reduce((sum, trip) => sum + (trip.miles || 0), 0);
            const totalGallons = totalMiles / avgMpg;
            const estimatedTotalCost = selectedTrips.reduce((sum, trip) => {
                const tripGasPrice = trip.gasPrice || gasPrice;
                return sum + ((trip.miles || 0) / avgMpg * tripGasPrice);
            }, 0);

            let reportHtml = `
                <div class="report-summary">
                    <h3 class="text-green-800">Trip Report</h3>
                    <p><strong>Total Miles Driven:</strong> ${totalMiles.toFixed(2)} miles</p>
                    <p><strong>Estimated Gallons Used:</strong> ${totalGallons.toFixed(2)} gallons</p>
                    <p><strong>Estimated Total Fuel Cost:</strong> $${estimatedTotalCost.toFixed(2)}</p>
                </div>
            `;

            const userCosts = {};
            selectedTrips.forEach(trip => {
                trip.users.forEach(userId => {
                    if (!userCosts[userId]) {
                        const user = users.find(u => u.id === userId);
                        userCosts[userId] = { name: user ? user.name : 'Unknown', miles: 0, cost: 0 };
                    }
                    const milesPerUser = (trip.miles || 0) / trip.users.length;
                    const tripGasPrice = trip.gasPrice || gasPrice;
                    userCosts[userId].miles += milesPerUser;
                    userCosts[userId].cost += (milesPerUser / avgMpg * tripGasPrice);
                });
            });

            reportHtml += `<h3 class="mt-8 text-green-800 font-bold text-xl">Individual Cost Breakdown</h3>`;
            reportHtml += `<ul class="list-disc ml-6 mt-4 space-y-2">`;
            for (const userId in userCosts) {
                const user = userCosts[userId];
                reportHtml += `<li><strong>${escapeHtml(user.name)}:</strong> ${user.miles.toFixed(2)} miles ($${user.cost.toFixed(2)})</li>`;
            }
            reportHtml += `</ul>`;
            return reportHtml;
        }

        function showPaymentConfirmation(tripsToPay, gasPrice, avgMpg) {
            const reportHtml = generateReport(tripsToPay, gasPrice, avgMpg);
            showModal(
                reportHtml,
                true,
                async () => {
                    const paidUserIds = [...new Set(tripsToPay.flatMap(t => t.users))];
                    try {
                        for (const trip of tripsToPay) {
                            const usedGasPrice = trip.gasPrice || gasPrice;
                            const gallons = trip.miles / avgMpg;
                            const amount = gallons * usedGasPrice;
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/trips`, trip.id), {
                                paid: true,
                                paidAmount: amount,
                                paidGasPrice: usedGasPrice,
                                paidDate: new Date().toISOString()
                            });
                        }
                        generateTripReportPdf(tripsToPay, paidUserIds, gasPrice, avgMpg, true);
                        showModal('Trips paid successfully!');
                        const selectedUserCheckboxes = document.querySelectorAll('input[name="payUser"]:checked');
                        const selectedUserIds = Array.from(selectedUserCheckboxes).map(cb => cb.value);
                        renderPayTripsAndTotals(selectedUserIds);
                    } catch (error) {
                        console.error("Error paying trips:", error);
                        showModal(`Failed to pay trips: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
                    }
                }
            );
        }

        function generateTripReportPdf(tripsToInclude, selectedUserIds, gasPrice, avgMpg, isPayment = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(isPayment ? 'Trip Payment Report' : 'Trip Report', 10, 10);

            const totalMiles = tripsToInclude.reduce((sum, trip) => sum + (trip.miles || 0), 0);
            const totalGallons = totalMiles / avgMpg;
            const estimatedTotalCost = tripsToInclude.reduce((sum, trip) => {
                const tripGasPrice = trip.gasPrice || gasPrice;
                return sum + ((trip.miles || 0) / avgMpg * tripGasPrice);
            }, 0);

            doc.setFontSize(12);
            doc.text(`Total Miles Driven: ${totalMiles.toFixed(2)} miles`, 10, 20);
            doc.text(`Estimated Gallons Used: ${totalGallons.toFixed(2)} gallons`, 10, 30);
            doc.text(`Estimated Total Fuel Cost: $${estimatedTotalCost.toFixed(2)}`, 10, 40);

            let y = 50;
            if (isPayment) {
                doc.text(`Paid On: ${new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' })}`, 10, 50);
                y = 60;
            }

            const userCosts = users.reduce((acc, user) => {
                if (selectedUserIds.includes(user.id)) {
                    acc[user.id] = { name: user.name, miles: 0, cost: 0 };
                }
                return acc;
            }, {});

            tripsToInclude.forEach(trip => {
                if (!trip.users || trip.users.length === 0) return;
                const milesPerUser = (trip.miles || 0) / trip.users.length;
                const tripGasPrice = trip.gasPrice || gasPrice;
                trip.users.forEach(userId => {
                    if (userCosts[userId]) {
                        userCosts[userId].miles += milesPerUser;
                        userCosts[userId].cost += (milesPerUser / avgMpg * tripGasPrice);
                    }
                });
            });

            doc.text('Individual Cost Breakdown', 10, y);
            y += 10;
            for (const userId in userCosts) {
                const user = userCosts[userId];
                doc.text(`${user.name}: ${user.miles.toFixed(2)} miles ($${user.cost.toFixed(2)})`, 10, y);
                y += 10;
            }

            if (tripsToInclude.length > 0) {
                doc.text('Trip Details', 10, y);
                y += 10;
                tripsToInclude.forEach((trip, index) => {
                    const userNames = trip.users.map(id => users.find(u => u.id === id)?.name || 'Unknown').join(', ');
                    const sharedNote = trip.shared ? `(Shared with: ${trip.sharedWith ? trip.sharedWith.map(id => users.find(u => u.id === id)?.name || 'Unknown').join(', ') : ''})` : '';
                    doc.text(`${index + 1}. ${trip.destination || 'No destination'} ${sharedNote}`, 10, y);
                    doc.text(`   Miles: ${trip.miles || 0}, Gas Price: $${trip.gasPrice || gasPrice}, Date: ${trip.timestamp ? new Date(trip.timestamp).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }) : 'Unknown'}`, 10, y + 5);
                    y += 15;
                });
            }

            const filename = isPayment ? `trip-payment-${new Date().toISOString().split('T')[0]}.pdf` : `trip-report-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        function generateSearchReport(filteredTrips) {
            const searchResults = document.getElementById('searchResults');
            if (!searchResults) return;

            let reportHtml = `<h3 class="text-xl font-bold mt-4">Search Results</h3>`;
            if (filteredTrips.length === 0) {
                reportHtml += `<p>No trips found for the selected criteria.</p>`;
            } else {
                reportHtml += `<ul class="item-list">`;
                filteredTrips.forEach(trip => {
                    const userNames = trip.users.map(id => users.find(u => u.id === id)?.name || 'Unknown').join(', ');
                    const sharedNote = trip.shared ? `(Shared with: ${trip.sharedWith ? trip.sharedWith.map(id => users.find(u => u.id === id)?.name || 'Unknown').join(', ') : ''})` : '';
                    const gasPriceDisplay = trip.paid ? (trip.paidGasPrice ?? trip.gasPrice ?? 'N/A') : (trip.gasPrice ?? 'N/A');
                    const paidAmountHtml = trip.paid ? `<p class="text-sm text-gray-500">Amount Paid: $${escapeHtml(String(trip.paidAmount ?? 'N/A'))}</p>` : '';
                    reportHtml += `
                        <li class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${escapeHtml(trip.destination || 'No destination')} ${escapeHtml(sharedNote)}</p>
                                <p class="text-sm text-gray-500">Miles: ${escapeHtml(String(trip.miles ?? '0'))}</p>
                                <p class="text-sm text-gray-500">Gas Price: $${escapeHtml(String(gasPriceDisplay))}</p>
                                ${paidAmountHtml}
                                <p class="text-sm text-gray-500">Users: ${escapeHtml(userNames)}</p>
                                <p class="text-sm text-gray-500">Notes: ${escapeHtml(trip.notes || 'N/A')}</p>
                                <p class="text-sm text-gray-500">Date: ${escapeHtml(trip.timestamp ? new Date(trip.timestamp).toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }) : 'Unknown')}</p>
                                <p class="text-sm text-gray-500">Status: ${trip.paid ? 'Paid' : 'Unpaid'}</p>
                            </div>
                            <div>
                                <button class="delete-btn" data-trip-id="${trip.id}">Delete</button>
                            </div>
                        </li>
                    `;
                });
                reportHtml += `</ul>`;
                reportHtml += `<button id="searchPdfBtn" class="pdf-btn mt-4">Create PDF</button>`;
            }

            searchResults.innerHTML = reportHtml;
            const pdfBtn = document.getElementById('searchPdfBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', () => {
                    generateTripReportPdf(filteredTrips, users.map(u => u.id), 0, 1, false);
                });
            }
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tripId = btn.getAttribute('data-trip-id');
                    const trip = trips.find(t => t.id === tripId);
                    showModal(
                        `Deleting this record cannot be undone. Proceed anyway?`,
                        true,
                        () => {
                            deleteTrip(tripId);
                            updateSearchResults();
                        }
                    );
                });
            });
        }

        function renderPayTripsAndTotals(selectedUserIds) {
            const container = document.getElementById('payTripsContainer');
            const totals = document.getElementById('payTotals');
            if (!container || !totals) return;
            container.innerHTML = '';
            totals.innerHTML = '';
            if (selectedUserIds.length === 0) return;

            const unpaidTrips = trips.filter(trip => !trip.paid && selectedUserIds.some(id => trip.users.includes(id)));
            if (unpaidTrips.length === 0) {
                container.innerHTML = '<p class="no-users-message">No unpaid trips for selected users.</p>';
                return;
            }

            unpaidTrips.forEach(trip => {
                const user = users.find(u => u.id === trip.users[0]);
                const item = document.createElement('div');
                item.className = 'trip-item';
                item.innerHTML = `
                    <input type="checkbox" class="trip-checkbox form-checkbox text-blue-600 rounded" value="${trip.id}" checked>
                    <div class="trip-details">
                        <p>${escapeHtml(trip.destination || 'No destination')} - ${escapeHtml(user ? user.name : 'Unknown')}</p>
                        <p class="text-sm text-gray-500">Miles: ${escapeHtml(String(trip.miles ?? '0'))}, Date: ${escapeHtml(trip.timestamp ? new Date(trip.timestamp).toLocaleDateString('en-US', { timeZone: 'America/Los_Angeles' }) : 'Unknown')}</p>
                    </div>
                `;
                container.appendChild(item);
            });

            document.querySelectorAll('.trip-checkbox').forEach(cb => {
                cb.addEventListener('change', updatePayTotals);
            });
            updatePayTotals();
        }

        function updatePayTotals() {
            const gasPrice = parseFloat(document.getElementById('gasPrice').value) || 0;
            const avgMpg = parseFloat(document.getElementById('avgMpg').value) || 0;
            const checkedCheckboxes = document.querySelectorAll('.trip-checkbox:checked');
            let totalCost = 0;

            checkedCheckboxes.forEach(cb => {
                const trip = trips.find(t => t.id === cb.value);
                if (trip) {
                    const usedGasPrice = trip.gasPrice || gasPrice;
                    const cost = (trip.miles / avgMpg) * usedGasPrice;
                    totalCost += cost;
                }
            });

            document.getElementById('payTotals').innerHTML = `Total to Pay: $${totalCost.toFixed(2)}`;

            const payBtn = document.getElementById('payNowBtn');
            const canPay = checkedCheckboxes.length > 0 && gasPrice > 0 && avgMpg > 0;
            payBtn.classList.toggle('disabled', !canPay);
            payBtn.disabled = !canPay;
        }

        function getPacificTime() {
            return new Date().toLocaleString('en-US', {
                timeZone: 'America/Los_Angeles',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/(\d+)\/(\d+)\/(\d+), (\d+):(\d+)/, '$3-$1-$2T$4:$5');
        }

        // ---------- Event Listeners ----------
        function setupEventListeners() {
            document.getElementById('tripsTab').addEventListener('click', () => switchTab('trips'));
            document.getElementById('usersTab').addEventListener('click', () => switchTab('users'));
            document.getElementById('payTab').addEventListener('click', () => switchTab('pay'));
            document.getElementById('advancedTab').addEventListener('click', () => switchTab('advanced'));

            document.getElementById('modalClose').addEventListener('click', hideModal);

            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userName = document.getElementById('userName')?.value?.trim();
                    if (!userName) {
                        showModal('Please enter a user name.');
                        return;
                    }
                    if (!db) {
                        showModal('Not connected to Firebase.');
                        return;
                    }
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/users`), {
                            name: userName,
                            timestamp: serverTimestamp(),
                            favorites: []
                        });
                        userForm.reset();
                        showModal('User added successfully!');
                    } catch (error) {
                        console.error("Error adding user:", error);
                        showModal(`Failed to add user: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
                    }
                });
            }

            const tripForm = document.getElementById('tripForm');
            if (tripForm) {
                // Set default current date/time in Pacific Time
                document.getElementById('tripDateTime').value = getPacificTime();

                document.getElementById('favoriteTrip').addEventListener('change', () => {
                    const select = document.getElementById('favoriteTrip');
                    const tripId = select.value;
                    const favoriteCheckbox = document.getElementById('tripFavorite');
                    if (!tripId) {
                        document.getElementById('tripDestination').value = '';
                        document.getElementById('tripMiles').value = '';
                        document.getElementById('tripGasPrice').value = '';
                        document.getElementById('tripNotes').value = '';
                        favoriteCheckbox.checked = false;
                        return;
                    }
                    const trip = trips.find(t => t.id === tripId);
                    if (trip) {
                        document.getElementById('tripDestination').value = trip.destination;
                        document.getElementById('tripMiles').value = trip.miles;
                        document.getElementById('tripGasPrice').value = '';
                        document.getElementById('tripNotes').value = trip.notes || '';
                        document.getElementById('tripDateTime').value = getPacificTime();
                        favoriteCheckbox.checked = true;
                    }
                });

                tripForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const destination = document.getElementById('tripDestination')?.value?.trim() || '';
                    const milesRaw = document.getElementById('tripMiles')?.value;
                    const miles = milesRaw ? parseFloat(milesRaw) : 0;
                    if (miles <= 0) {
                        showModal('Miles must be positive.');
                        return;
                    }
                    const gasPrice = parseFloat(document.getElementById('tripGasPrice')?.value) || null;
                    const timestampStr = document.getElementById('tripDateTime')?.value;
                    if (!timestampStr) {
                        showModal('Please select a date and time.');
                        return;
                    }
                    const timestamp = new Date(timestampStr).toISOString();
                    const notes = document.getElementById('tripNotes')?.value?.trim() || '';
                    const selectedUserCheckboxes = document.querySelectorAll('input[name="tripUser"]:checked');
                    const selectedUserIds = Array.from(selectedUserCheckboxes).map(cb => cb.value);
                    const isFavorite = document.getElementById('tripFavorite').checked;
                    const selectedFavorite = document.getElementById('favoriteTrip').value;

                    if (selectedUserIds.length === 0) {
                        showModal("Please select at least one responsible user.");
                        return;
                    }
                    if (!db) {
                        showModal('Not connected to Firebase.');
                        return;
                    }

                    try {
                        let newTripId;
                        if (selectedUserIds.length === 1) {
                            // Single user trip
                            const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/trips`), {
                                destination,
                                miles,
                                gasPrice,
                                timestamp,
                                notes,
                                users: selectedUserIds,
                                paid: false,
                                shared: false,
                                sharedWith: [],
                                created: serverTimestamp()
                            });
                            newTripId = docRef.id;
                        } else {
                            // Shared trip: Create a record for each user
                            const milesPerUser = miles / selectedUserIds.length;
                            for (const userId of selectedUserIds) {
                                await addDoc(collection(db, `artifacts/${appId}/public/data/trips`), {
                                    destination,
                                    miles: milesPerUser,
                                    gasPrice,
                                    timestamp,
                                    notes,
                                    users: [userId],
                                    paid: false,
                                    shared: true,
                                    sharedWith: selectedUserIds.filter(id => id !== userId),
                                    created: serverTimestamp()
                                });
                            }
                        }

                        // Handle favorites for single user
                        if (selectedUserIds.length === 1) {
                            const userId = selectedUserIds[0];
                            const userRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                            if (isFavorite && newTripId) {
                                await updateDoc(userRef, {
                                    favorites: arrayUnion(newTripId)
                                });
                            } else if (!isFavorite && selectedFavorite) {
                                await updateDoc(userRef, {
                                    favorites: arrayRemove(selectedFavorite)
                                });
                            }
                        }

                        tripForm.reset();
                        selectedUserCheckboxes.forEach(cb => cb.checked = false);
                        document.getElementById('tripDateTime').value = getPacificTime();
                        document.getElementById('tripFavorite').checked = false;
                        showModal('Trip added successfully!');
                    } catch (error) {
                        console.error("Error adding trip:", error);
                        showModal(`Failed to add trip: ${error.message || error.code || 'Unknown error. Check console for details.'}`, false);
                    }
                });
            }

            const payUsersContainer = document.getElementById('payUsersContainer');
            if (payUsersContainer) {
                payUsersContainer.addEventListener('change', (e) => {
                    if (e.target.name === 'payUser') {
                        const selectedUserCheckboxes = document.querySelectorAll('input[name="payUser"]:checked');
                        const selectedUserIds = Array.from(selectedUserCheckboxes).map(cb => cb.value);
                        renderPayTripsAndTotals(selectedUserIds);
                    }
                });
            }

            const gasPriceInput = document.getElementById('gasPrice');
            const avgMpgInput = document.getElementById('avgMpg');
            if (gasPriceInput && avgMpgInput) {
                gasPriceInput.addEventListener('input', updatePayTotals);
                avgMpgInput.addEventListener('input', updatePayTotals);
            }

            const payNowBtn = document.getElementById('payNowBtn');
            if (payNowBtn) {
                payNowBtn.addEventListener('click', () => {
                    const gasPrice = parseFloat(document.getElementById('gasPrice').value);
                    const avgMpg = parseFloat(document.getElementById('avgMpg').value);
                    if (isNaN(gasPrice) || gasPrice <= 0 || isNaN(avgMpg) || avgMpg <= 0) {
                        showModal('Please enter valid positive values for gas price and MPG.');
                        return;
                    }
                    const checkedTripCheckboxes = document.querySelectorAll('.trip-checkbox:checked');
                    const tripIdsToPay = Array.from(checkedTripCheckboxes).map(cb => cb.value);
                    if (tripIdsToPay.length === 0) {
                        showModal('No trips selected to pay.');
                        return;
                    }
                    const tripsToPay = trips.filter(t => tripIdsToPay.includes(t.id));
                    showPaymentConfirmation(tripsToPay, gasPrice, avgMpg);
                });
            }

            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    updateSearchResults();
                });
            }

            const resetDatesBtn = document.getElementById('resetDatesBtn');
            if (resetDatesBtn) {
                resetDatesBtn.addEventListener('click', () => {
                    document.getElementById('startDate').value = '';
                    document.getElementById('endDate').value = '';
                    updateSearchResults();
                    showModal('Dates reset.');
                });
            }
        }

        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ---------- Initialize App ----------
        window.addEventListener('load', () => {
            initializeFirebase();
            setupEventListeners();
            switchTab('trips');
        });
    </script>
</body>
</html>
