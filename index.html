<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section-container {
            background-color: #ffffff;
            border-radius: 0 1rem 1rem 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            background-color: #e5e7eb;
            z-index: 10;
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3b82f6;
            border-top: 2px solid #3b82f6;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            margin-bottom: -1px; /* Overlap with section container border */
        }
        .tab-group {
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            z-index: 0;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .input-group input, .input-group textarea, .input-group select {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .item-list {
            list-style: none;
            padding: 0;
        }
        .item-list li {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-8">Trip Tracker</h1>
        <p id="userIdDisplay" class="text-center text-sm text-gray-500 mb-4"></p>

        <!-- Tabs for different sections of the app -->
        <div class="flex tab-group">
            <button id="tripsTab" class="tab-button active">Trips</button>
            <button id="usersTab" class="tab-button">Users</button>
            <button id="fillupTab" class="tab-button">Fill-Up & Report</button>
        </div>

        <!-- Trips Section -->
        <div id="tripsSection" class="section-container">
            <h2 class="text-2xl font-bold mb-4">Log a New Trip</h2>
            <form id="tripForm" class="space-y-4">
                <div class="input-group">
                    <label for="tripDestination">Destination</label>
                    <input type="text" id="tripDestination" placeholder="e.g., San Francisco, CA" required>
                </div>
                <div class="input-group">
                    <label for="tripMiles">Miles Driven</label>
                    <input type="number" id="tripMiles" placeholder="e.g., 250" required>
                </div>
                <div class="input-group">
                    <label for="tripNotes">Notes</label>
                    <textarea id="tripNotes" placeholder="e.g., Drove to the conference" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Responsible Users</label>
                    <div id="tripUsersContainer" class="flex flex-wrap gap-2">
                        <!-- Checkboxes for users will be dynamically added here by JavaScript -->
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Add Trip</button>
            </form>
            <h2 class="text-2xl font-bold mt-8 mb-4">Logged Trips</h2>
            <ul id="tripsList" class="item-list"></ul>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden section-container">
            <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
            <form id="userForm" class="space-y-4 mb-8">
                <div class="input-group">
                    <label for="userName">User Name</label>
                    <input type="text" id="userName" placeholder="e.g., John Doe" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Add User</button>
            </form>
            <h2 class="text-2xl font-bold mb-4">Current Users</h2>
            <ul id="usersList" class="item-list"></ul>
        </div>

        <!-- Fill-up & Report Section -->
        <div id="fillupSection" class="hidden section-container">
            <h2 class="text-2xl font-bold mb-4">Enter Fill-Up Details</h2>
            <form id="fillupForm" class="space-y-4 mb-8">
                <div class="input-group">
                    <label for="gasPrice">Gas Price Per Gallon ($)</label>
                    <input type="number" step="0.01" id="gasPrice" placeholder="e.g., 3.50" required>
                </div>
                <div class="input-group">
                    <label for="avgMpg">Average MPG</label>
                    <input type="number" step="0.1" id="avgMpg" placeholder="e.g., 25.5" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Generate Report & Archive</button>
            </form>
            <div id="reportContainer" class="hidden p-6 rounded-lg bg-gray-50 border border-gray-200">
                <h3 class="text-xl font-bold mb-4">Trip Report</h3>
                <div id="reportDetails"></div>
            </div>
            <h2 class="text-2xl font-bold mt-8 mb-4">Past Reports</h2>
            <ul id="reportsList" class="item-list"></ul>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg text-center">
            <p id="modalMessage" class="mb-4 text-lg"></p>
            <button id="modalClose" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let trips = []; // In-memory cache for trips
        let usersMap = {}; // In-memory map for fast user lookups {userId: userName}

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is not available.");
                showModal("Firebase is not configured. The app will not function correctly.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                console.log("User authenticated with ID:", userId);

                // Set up real-time listeners for all collections
                setupRealtimeListeners();
            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                showModal("Could not connect to Firebase. Please check the console for details.");
            }
        }

        // --- UI & Event Handlers ---
        document.getElementById('tripsTab').addEventListener('click', () => switchTab('trips'));
        document.getElementById('usersTab').addEventListener('click', () => switchTab('users'));
        document.getElementById('fillupTab').addEventListener('click', () => switchTab('fillup'));

        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section-container').forEach(section => section.classList.add('hidden'));

            document.getElementById(`${tabId}Tab`).classList.add('active');
            document.getElementById(`${tabId}Section`).classList.remove('hidden');
        }

        function showModal(message) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modalMessage');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        document.getElementById('modalClose').addEventListener('click', () => {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // --- Firestore Listeners ---
        function setupRealtimeListeners() {
            // Listen for changes to the users collection
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            onSnapshot(usersCollectionRef, (querySnapshot) => {
                usersMap = {}; // Reset the local users map
                const usersListElement = document.getElementById('usersList');
                const tripUsersContainer = document.getElementById('tripUsersContainer');

                usersListElement.innerHTML = '';
                tripUsersContainer.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const user = { id: doc.id, name: userData.name };
                    usersMap[user.id] = user.name; // Populate the map

                    // Display user in the Users tab
                    const userLi = document.createElement('li');
                    userLi.innerHTML = `<span>${user.name}</span>`;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => deleteUser(user.id));
                    userLi.appendChild(deleteBtn);
                    usersListElement.appendChild(userLi);

                    // Create a checkbox for each user in the Trips tab
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                    label.innerHTML = `
                        <input type="checkbox" name="tripUser" value="${user.id}" class="form-checkbox text-blue-600 rounded">
                        <span>${user.name}</span>
                    `;
                    tripUsersContainer.appendChild(label);
                });
            }, (error) => {
                console.error("Error getting users data: ", error);
            });

            // Listen for changes to the trips collection
            const tripsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips`);
            onSnapshot(tripsCollectionRef, (querySnapshot) => {
                trips = [];
                querySnapshot.forEach((doc) => {
                    trips.push({ id: doc.id, ...doc.data() });
                });
                trips.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                displayTrips();
            }, (error) => {
                console.error("Error getting trips data: ", error);
            });

            // Listen for changes to the reports collection
            const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);
            onSnapshot(reportsCollectionRef, (querySnapshot) => {
                const reports = [];
                querySnapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                reports.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                displayReports(reports);
            }, (error) => {
                console.error("Error getting reports data: ", error);
            });
        }

        // --- Form Submission Handlers ---
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userName = document.getElementById('userName').value;
            if (!userName.trim()) {
                showModal("Please enter a user name.");
                return;
            }
            const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            try {
                await addDoc(usersCollectionRef, {
                    name: userName,
                    timestamp: serverTimestamp()
                });
                e.target.reset();
            } catch (error) {
                console.error("Error adding user:", error);
                showModal("Failed to add user. Please check your internet connection.");
            }
        });

        document.getElementById('tripForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripDestination = document.getElementById('tripDestination').value;
            const tripMiles = parseFloat(document.getElementById('tripMiles').value);
            const tripNotes = document.getElementById('tripNotes').value;

            // Get selected user IDs from checkboxes
            const selectedUserCheckboxes = document.querySelectorAll('input[name="tripUser"]:checked');
            const selectedUserIds = Array.from(selectedUserCheckboxes).map(checkbox => checkbox.value);

            if (selectedUserIds.length === 0) {
                showModal("Please select at least one responsible user.");
                return;
            }

            const tripsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips`);
            try {
                await addDoc(tripsCollectionRef, {
                    destination: tripDestination,
                    miles: tripMiles,
                    notes: tripNotes,
                    users: selectedUserIds,
                    timestamp: serverTimestamp()
                });
                e.target.reset();
                selectedUserCheckboxes.forEach(checkbox => checkbox.checked = false);
            } catch (error) {
                console.error("Error adding trip:", error);
                showModal("Failed to add trip. Please check your internet connection.");
            }
        });

        document.getElementById('fillupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const gasPrice = parseFloat(document.getElementById('gasPrice').value);
            const avgMpg = parseFloat(document.getElementById('avgMpg').value);

            if (trips.length === 0) {
                showModal("There are no trips to report on. Please log some trips first.");
                return;
            }
            if (gasPrice <= 0 || avgMpg <= 0) {
                showModal("Gas price and average MPG must be positive numbers.");
                return;
            }

            // Calculate total miles and cost
            const totalMiles = trips.reduce((sum, trip) => sum + trip.miles, 0);
            const totalGallons = totalMiles / avgMpg;
            const totalCost = totalGallons * gasPrice;

            // Group trips by user and calculate individual miles and cost
            const userTotals = {};
            trips.forEach(trip => {
                const milesPerUser = trip.miles / trip.users.length;
                const costPerUser = (milesPerUser / avgMpg) * gasPrice;

                trip.users.forEach(userId => {
                    const userName = usersMap[userId] || 'Unknown User';
                    if (!userTotals[userId]) {
                        userTotals[userId] = {
                            name: userName,
                            miles: 0,
                            cost: 0
                        };
                    }
                    userTotals[userId].miles += milesPerUser;
                    userTotals[userId].cost += costPerUser;
                });
            });

            // Display the report
            const reportDetails = document.getElementById('reportDetails');
            reportDetails.innerHTML = `
                <p><strong>Total Miles Driven:</strong> ${totalMiles.toFixed(2)}</p>
                <p><strong>Total Gallons Used:</strong> ${totalGallons.toFixed(2)}</p>
                <p><strong>Total Fuel Cost:</strong> $${totalCost.toFixed(2)}</p>
                <h4 class="font-bold mt-4">Cost per User:</h4>
                <ul class="list-disc ml-6 mt-2">
                    ${Object.values(userTotals).map(user => `
                        <li>${user.name}: $${user.cost.toFixed(2)} (${user.miles.toFixed(2)} miles)</li>
                    `).join('')}
                </ul>
            `;
            document.getElementById('reportContainer').classList.remove('hidden');

            // Archive the report and clear trips
            try {
                const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);
                await addDoc(reportsCollectionRef, {
                    report: {
                        totalMiles,
                        totalGallons,
                        totalCost,
                        users: userTotals,
                        date: new Date().toISOString()
                    },
                    timestamp: serverTimestamp()
                });

                // Delete all trips after archiving the report
                const deletePromises = trips.map(trip => deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, trip.id)));
                await Promise.all(deletePromises);

                showModal("Report generated and trips have been archived!");
                e.target.reset();
            } catch (error) {
                console.error("Error archiving report or clearing trips:", error);
                showModal("Failed to archive report or clear trips.");
            }
        });

        // --- Firestore Deletion Functions ---
        async function deleteUser(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, id));
            } catch (error) {
                console.error("Error deleting user:", error);
                showModal("Failed to delete user. Please try again.");
            }
        }

        async function deleteTrip(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips`, id));
            } catch (error) {
                console.error("Error deleting trip:", error);
                showModal("Failed to delete trip. Please try again.");
            }
        }

        async function deleteReport(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/reports`, id));
            } catch (error) {
                console.error("Error deleting report:", error);
                showModal("Failed to delete report. Please try again.");
            }
        }

        // --- UI Display Functions ---
        function displayTrips() {
            const tripsListElement = document.getElementById('tripsList');
            tripsListElement.innerHTML = '';
            trips.forEach(trip => {
                const responsibleUserNames = trip.users.map(userId => {
                    return usersMap[userId] || 'Unknown User';
                }).join(', ');

                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <p class="font-bold">${trip.destination}</p>
                        <p class="text-sm text-gray-500">Miles: ${trip.miles}</p>
                        <p class="text-sm text-gray-500">Users: ${responsibleUserNames}</p>
                        <p class="text-sm text-gray-500">Notes: ${trip.notes || 'N/A'}</p>
                        <p class="text-sm text-gray-500">Date: ${new Date(trip.timestamp.toDate()).toLocaleString()}</p>
                    </div>
                `;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteTrip(trip.id));
                li.appendChild(deleteBtn);
                tripsListElement.appendChild(li);
            });
        }

        function displayReports(reports) {
            const reportsListElement = document.getElementById('reportsList');
            reportsListElement.innerHTML = '';
            reports.forEach(reportDoc => {
                const report = reportDoc.report;
                const li = document.createElement('li');
                li.classList.add('flex-col', 'items-start'); // Adjust for multiline content
                li.innerHTML = `
                    <div class="w-full">
                        <p class="font-bold">Report from ${new Date(reportDoc.timestamp.toDate()).toLocaleString()}</p>
                        <p class="text-sm text-gray-500">Total Miles: ${report.totalMiles.toFixed(2)}</p>
                        <p class="text-sm text-gray-500">Total Cost: $${report.totalCost.toFixed(2)}</p>
                        <p class="text-sm text-gray-500">Users: ${Object.values(report.users).map(u => u.name).join(', ')}</p>
                    </div>
                `;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn mt-2';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteReport(reportDoc.id));
                li.appendChild(deleteBtn);
                reportsListElement.appendChild(li);
            });
        }

        // Initialize the app on page load
        initializeFirebase();
    </script>
</body>
</html>
