<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trip Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section-container {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: #ffffff;
            color: #3b82f6;
            border-top: 2px solid #3b82f6;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            border-bottom: none;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .input-group input, .input-group textarea, .input-group select {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .item-list {
            list-style: none;
            padding: 0;
        }
        .item-list li {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
        .archive-btn {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            border: none;
        }
        .archive-btn:hover {
            background-color: #059669;
        }
        .restore-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            border: none;
        }
        .restore-btn:hover {
            background-color: #2563eb;
        }
        /* modal layout */
        .modal-flex {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .report-summary {
            background-color: #f0fdf4;
            border: 2px solid #4ade80;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        .report-summary h3 {
            font-weight: bold;
            font-size: 1.25rem;
            color: #166534;
            margin-bottom: 1rem;
        }
        .backup-section {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-8">Trip Tracker</h1>
        <p class="text-center text-sm text-gray-500 mb-4">Data stored locally in your browser (persists on refresh/close). Use Archive to backup!</p>

        <!-- Tabs -->
        <div class="flex">
            <button id="tripsTab" class="tab-button active">Trips</button>
            <button id="usersTab" class="tab-button">Users</button>
            <button id="fillupTab" class="tab-button">Fill-Up & Report</button>
        </div>

        <!-- Trips Section -->
        <div id="tripsSection" class="section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Log a New Trip</h2>
            <form id="tripForm" class="space-y-4">
                <div class="input-group">
                    <label for="tripDestination">Destination</label>
                    <input type="text" id="tripDestination" placeholder="e.g., San Francisco, CA" required>
                </div>
                <div class="input-group">
                    <label for="tripMiles">Miles Driven</label>
                    <input type="number" id="tripMiles" placeholder="e.g., 250" required>
                </div>
                <div class="input-group">
                    <label for="tripNotes">Notes</label>
                    <textarea id="tripNotes" placeholder="e.g., Drove to the conference" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>Responsible Users</label>
                    <div id="tripUsersContainer" class="flex flex-wrap gap-2">
                        <!-- Checkboxes will be dynamically added here -->
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Add Trip</button>
            </form>

            <h2 class="text-2xl font-bold mt-8 mb-4">Logged Trips</h2>
            <ul id="tripsList" class="item-list"></ul>

            <h3 class="text-xl font-bold mt-8 mb-2">Backup / Restore Data</h3>
            <div class="backup-section">
                <button id="archiveBtn" class="archive-btn">Archive Data (Download Backup)</button>
                <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                <button id="restoreBtn" class="restore-btn">Restore from File</button>
            </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="hidden section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
            <form id="userForm" class="space-y-4 mb-8">
                <div class="input-group">
                    <label for="userName">User Name</label>
                    <input type="text" id="userName" placeholder="e.g., John Doe" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Add User</button>
            </form>
            <h2 class="text-2xl font-bold mb-4">Current Users</h2>
            <ul id="usersList" class="item-list"></ul>
        </div>

        <!-- Fill-up & Report Section -->
        <div id="fillupSection" class="hidden section-container mt-0">
            <h2 class="text-2xl font-bold mb-4">Enter Fill-Up Details</h2>
            <form id="fillupForm" class="space-y-4">
                <div class="input-group">
                    <label for="gasPrice">Gas Price Per Gallon ($)</label>
                    <input type="number" step="0.01" id="gasPrice" placeholder="e.g., 3.50" required>
                </div>
                <div class="input-group">
                    <label for="avgMpg">Average MPG</label>
                    <input type="number" step="0.1" id="avgMpg" placeholder="e.g., 25.5" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Generate Report</button>
            </form>
            <div id="reportContainer" class="hidden">
                <!-- Report will be generated here -->
            </div>
        </div>

    </div>

    <!-- Custom Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden modal-flex p-4">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg text-center">
            <p id="modalMessage" class="mb-4 text-lg"></p>
            <div id="modalButtons" class="flex justify-center gap-4">
                <button id="modalConfirm" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors hidden">Yes</button>
                <button id="modalClose" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Local Storage Keys
        const USERS_KEY = 'tripTrackerUsers';
        const TRIPS_KEY = 'tripTrackerTrips';

        // Global Data
        let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
        let trips = JSON.parse(localStorage.getItem(TRIPS_KEY)) || [];

        // ---------- UI Helpers ----------
        function switchTab(tabName) {
            const tabs = {
                trips: { button: 'tripsTab', section: 'tripsSection' },
                users: { button: 'usersTab', section: 'usersSection' },
                fillup: { button: 'fillupTab', section: 'fillupSection' }
            };

            Object.keys(tabs).forEach(key => {
                const btn = document.getElementById(tabs[key].button);
                const sec = document.getElementById(tabs[key].section);
                if (key === tabName) {
                    btn.classList.add('active');
                    sec.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    sec.classList.add('hidden');
                }
            });
        }

        function showModal(message, isConfirmation = false, onConfirmCallback = null) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirm');
            const modalCloseBtn = document.getElementById('modalClose');

            modalMessage.textContent = message;

            if (isConfirmation) {
                modalConfirmBtn.classList.remove('hidden');
                modalCloseBtn.textContent = 'No';
                modalConfirmBtn.onclick = () => {
                    hideModal();
                    if (onConfirmCallback) onConfirmCallback();
                };
            } else {
                modalConfirmBtn.classList.add('hidden');
                modalCloseBtn.textContent = 'OK';
                modalCloseBtn.onclick = hideModal;
            }
            modal.classList.remove('hidden');
        }

        function hideModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
        }

        // ---------- Save to LocalStorage ----------
        function saveData() {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            localStorage.setItem(TRIPS_KEY, JSON.stringify(trips));
        }

        // ---------- Backup / Restore Functions ----------
        function archiveData() {
            const backupData = {
                users: users,
                trips: trips,
                exportDate: new Date().toISOString()
            };
            const filename = `trip-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showModal('Backup file downloaded successfully!');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData.users || !Array.isArray(backupData.users) || !backupData.trips || !Array.isArray(backupData.trips)) {
                        throw new Error('Invalid backup file: Missing users or trips array.');
                    }

                    // Merge users: Add only new ones (by ID)
                    const existingUserIds = new Set(users.map(u => u.id));
                    const newUsers = backupData.users.filter(u => !existingUserIds.has(u.id));
                    users = [...users, ...newUsers];

                    // Merge trips: Add only new ones (by ID)
                    const existingTripIds = new Set(trips.map(t => t.id));
                    const newTrips = backupData.trips.filter(t => !existingTripIds.has(t.id));
                    trips = [...trips, ...newTrips];

                    // Sort trips by timestamp (newest first)
                    trips.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    saveData();
                    displayUsers();
                    displayTrips();
                    renderTripUserCheckboxes();
                    showModal(`Restored successfully! Added ${newUsers.length} users and ${newTrips.length} trips.`);
                } catch (error) {
                    console.error('Restore error:', error);
                    showModal(`Failed to restore: ${error.message}. Please check the file.`);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input for next use
        }

        // ---------- Event listeners ----------
        function setupEventListeners() {
            document.getElementById('tripsTab').addEventListener('click', () => switchTab('trips'));
            document.getElementById('usersTab').addEventListener('click', () => switchTab('users'));
            document.getElementById('fillupTab').addEventListener('click', () => switchTab('fillup'));

            document.getElementById('modalClose').addEventListener('click', hideModal);

            document.getElementById('archiveBtn').addEventListener('click', archiveData);

            const restoreBtn = document.getElementById('restoreBtn');
            const restoreFileInput = document.getElementById('restoreFileInput');
            restoreBtn.addEventListener('click', () => restoreFileInput.click());
            restoreFileInput.addEventListener('change', restoreData);

            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const userNameEl = document.getElementById('userName');
                    if (!userNameEl) return;
                    const userName = userNameEl.value.trim();
                    if (!userName) {
                        showModal('Please enter a user name.');
                        return;
                    }
                    const newUser = {
                        id: Date.now().toString(), // Simple unique ID
                        name: userName,
                        timestamp: new Date().toISOString()
                    };
                    users.push(newUser);
                    saveData();
                    userForm.reset();
                    displayUsers();
                    renderTripUserCheckboxes();
                    showModal('User added successfully!');
                });
            }

            const tripForm = document.getElementById('tripForm');
            if (tripForm) {
                tripForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const destination = document.getElementById('tripDestination')?.value?.trim() || '';
                    const milesRaw = document.getElementById('tripMiles')?.value;
                    const miles = milesRaw ? parseFloat(milesRaw) : 0;
                    const notes = document.getElementById('tripNotes')?.value?.trim() || '';
                    const selectedUserCheckboxes = document.querySelectorAll('input[name="tripUser"]:checked');
                    const selectedUserIds = Array.from(selectedUserCheckboxes).map(cb => cb.value);

                    if (selectedUserIds.length === 0) {
                        showModal("Please select at least one responsible user.");
                        return;
                    }
                    const newTrip = {
                        id: Date.now().toString(), // Simple unique ID
                        destination,
                        miles,
                        notes,
                        users: selectedUserIds,
                        timestamp: new Date().toISOString()
                    };
                    trips.push(newTrip);
                    trips.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort newest first
                    saveData();
                    tripForm.reset();
                    selectedUserCheckboxes.forEach(cb => cb.checked = false);
                    displayTrips();
                    showModal('Trip added successfully!');
                });
            }

            const fillupForm = document.getElementById('fillupForm');
            if (fillupForm) {
                fillupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const gasPrice = parseFloat(document.getElementById('gasPrice')?.value);
                    const avgMpg = parseFloat(document.getElementById('avgMpg')?.value);

                    if (isNaN(gasPrice) || isNaN(avgMpg) || gasPrice <= 0 || avgMpg <= 0) {
                        showModal('Please enter valid, positive numbers for gas price and MPG.');
                        return;
                    }

                    generateReport(gasPrice, avgMpg);
                });
            }
        }

        // ---------- Local Data Helpers ----------
        function deleteUser(userIdToDelete) {
            const tripsWithUser = trips.filter(trip => trip.users.includes(userIdToDelete));
            if (tripsWithUser.length > 0) {
                showModal(`Cannot delete user. This user is associated with ${tripsWithUser.length} trip(s).`, false);
                return;
            }
            users = users.filter(user => user.id !== userIdToDelete);
            saveData();
            displayUsers();
            renderTripUserCheckboxes();
            showModal('User deleted successfully!');
        }

        function deleteTrip(tripId) {
            trips = trips.filter(trip => trip.id !== tripId);
            saveData();
            displayTrips();
            showModal('Trip deleted successfully!');
        }

        // ---------- UI render functions ----------
        function renderTripUserCheckboxes() {
            const usersContainer = document.getElementById('tripUsersContainer');
            if (!usersContainer) return;
            usersContainer.innerHTML = '';
            users.forEach(user => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-gray-200 px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-gray-300';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'tripUser';
                input.value = user.id;
                input.className = 'form-checkbox text-blue-600 rounded';
                const span = document.createElement('span');
                span.textContent = escapeHtml(user.name);
                label.appendChild(input);
                label.appendChild(span);
                usersContainer.appendChild(label);
            });
        }

        function displayUsers() {
            const usersListElement = document.getElementById('usersList');
            if (!usersListElement) return;
            usersListElement.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = escapeHtml(user.name);
                li.appendChild(nameSpan);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    showModal(`Are you sure you want to delete "${user.name}"?`, true, () => deleteUser(user.id));
                });
                li.appendChild(deleteBtn);
                usersListElement.appendChild(li);
            });
        }

        function displayTrips() {
            const tripsListElement = document.getElementById('tripsList');
            if (!tripsListElement) return;
            tripsListElement.innerHTML = '';

            trips.forEach(trip => {
                const responsibleUserNames = Array.isArray(trip.users) ? trip.users.map(userId => {
                    const u = users.find(x => x.id === userId);
                    return u ? u.name : 'Unknown User';
                }).join(', ') : 'N/A';

                const dateStr = new Date(trip.timestamp).toLocaleString();

                const li = document.createElement('li');
                li.className = 'flex justify-between items-start';
                const left = document.createElement('div');
                left.innerHTML = `
                    <p class="font-bold">${escapeHtml(trip.destination || 'No destination')}</p>
                    <p class="text-sm text-gray-500">Miles: ${escapeHtml(String(trip.miles ?? '0'))}</p>
                    <p class="text-sm text-gray-500">Users: ${escapeHtml(responsibleUserNames)}</p>
                    <p class="text-sm text-gray-500">Notes: ${escapeHtml(trip.notes || 'N/A')}</p>
                    <p class="text-sm text-gray-500">Date: ${escapeHtml(dateStr)}</p>
                `;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    showModal(`Are you sure you want to delete the trip to "${trip.destination}"?`, true, () => deleteTrip(trip.id));
                });
                li.appendChild(left);
                li.appendChild(deleteBtn);
                tripsListElement.appendChild(li);
            });
        }

        function generateReport(gasPrice, avgMpg) {
            const reportContainer = document.getElementById('reportContainer');
            if (!reportContainer) return;

            const totalMiles = trips.reduce((sum, trip) => sum + (trip.miles || 0), 0);
            const totalGallons = totalMiles / avgMpg;
            const estimatedTotalCost = totalGallons * gasPrice;

            let reportHtml = `
                <div class="report-summary">
                    <h3 class="text-green-800">Trip Report</h3>
                    <p><strong>Total Miles Driven:</strong> ${totalMiles.toFixed(2)} miles</p>
                    <p><strong>Estimated Gallons Used:</strong> ${totalGallons.toFixed(2)} gallons</p>
                    <p><strong>Estimated Total Fuel Cost:</strong> $${estimatedTotalCost.toFixed(2)}</p>
                </div>
            `;

            // Generate user-specific cost breakdown
            const userCosts = users.reduce((acc, user) => {
                acc[user.id] = { name: user.name, miles: 0, cost: 0 };
                return acc;
            }, {});

            trips.forEach(trip => {
                if (!trip.users || trip.users.length === 0) return;
                const milesPerUser = (trip.miles || 0) / trip.users.length;
                trip.users.forEach(userId => {
                    if (userCosts[userId]) {
                        userCosts[userId].miles += milesPerUser;
                    }
                });
            });

            reportHtml += `<h3 class="mt-8 text-green-800 font-bold text-xl">Individual Cost Breakdown</h3>`;
            reportHtml += `<ul class="list-disc ml-6 mt-4 space-y-2">`;
            for (const userId in userCosts) {
                const user = userCosts[userId];
                const userGallons = user.miles / avgMpg;
                const userCost = userGallons * gasPrice;
                reportHtml += `<li><strong>${escapeHtml(user.name)}:</strong> ${user.miles.toFixed(2)} miles ($${userCost.toFixed(2)})</li>`;
            }
            reportHtml += `</ul>`;

            reportContainer.innerHTML = reportHtml;
            reportContainer.classList.remove('hidden');
        }

        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ---------- Initialize App ----------
        function initializeApp() {
            setupEventListeners();
            displayUsers();
            displayTrips();
            renderTripUserCheckboxes();
            switchTab('trips'); // Default tab
        }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
